---
title: "Data Wrangling Final Project"
author: "Brianna Eskin"
date: "4/14/2020"
output: pdf_document
---
```{r packages, echo=FALSE, warning=FALSE}
source("C:\\Users\\Brianna\\Documents\\R\\597\\Final Project\\DataWranglingProjectSpring2020\\functions.r")
library(tidyverse)
library(rvest)
library(stringr)
library(purrr)
options(scipen = 999999)
```

## Introduction

  The game show Jeopardy!, created by Merv Griffin and hosted by Art Fleming, first premiered on March 30, 1964 on NBC. After a few different syndicated versions, the show as it is known today, hosted by Alex Trebek, premiered on September 10, 1984. Since its premiere, the current version of Jeopardy!, which is in its 36th season, has aired over 8000 episodes, won over 30 Daytime Emmy awards, and is often regarded as one of the greatest television shows in American television history.

  Despite a few minor tweaks over time, the gameplay of Jeopardy! has remained largely the same. There are three rounds in a standard game of Jeopardy!, the Jeopardy round, Double Jeopardy, and Final Jeopardy. In the first two rounds, contestants select clues from six predetermined categories valued by difficulty. These clues are presented as "answers" and the responses from the contestants are given in the form of a question. For example, the clue might say "This is the official state university of New Jersey". The first contestant to buzz in would give the response of "What is Rutgers University?". If the contestant responds correctly, he/she is awarded money based on the value of the clue. If the contestant responds incorrectly, he/she loses money based on the value of the clue. Under some clues- one in the Jeopardy round and two in the Double Jeopardy round- there is a Daily Double. When the Daily Double is found, the contestant, who has the clue all to themselves, can wager any or all of the current money they have available, and gain or lose that amount depending on their response to the clue. After the first two rounds, there is a Final Jeopardy round. In Final Jeopardy, the contestants are given the category and based on factors including their confidence in the category and the scores of themselves/their opponents, wager any or all of their winnings, similar to a Daily Double. Then the clue is revealed and the contestants write their answers at their podium. Their reponses and wagers are then revealed and after this round, whoever has the most money is declared the victor and comes back the next day as the returning Champion, getting to keep all of the money they earned.

  For my project, I will be wrangling data pertaining to the all time highest Jeopardy! winners, as listed on https://www.jeopardy.com/contestant-zone/hall-of-fame. As of April 14, 2020 these contestants are:
  
1. Brad Rutter
2. Ken Jennings
3. James Holzhauer
4. David Madden
5. Larissa Kelly
6. Matt Jackson
7. Jason Zuffranieri
8. Roger Craig
9. Colby Burnett
10. Julia Collins

For each of the all time highest Jeopardy!, I will be analyzing their overall winnings, as well as their individual regular season and tournament gameplays. I will be looking at their distribution of money earned in regular season play versus the various tournaments Jeopardy! has held over the years. I will also be analyzing individual game scores and statistics.

  I was interested in data pertaining to Jeopardy! because of the personal connection Jeopardy! has in my life. Jeopardy! is my favorite television show, and one of the few television programs I watch on a consistent basis. I started wathcing afternoon reruns with my grandmother while she babysat us during school vacations, but given that I was in elementary school at the time, I couldn't keep up most of the time. After she passed away in 2007, I fell off of watching for a bit, but got back into it during high school. My dad would start watching with me, not necessarily because he was also into it, but because I would take up the good television in our living room and he didn't feel like moving. Over time, both of our investments in the game began to grow and for years, we never missed a game, even while he was spending nights in the hospital due to complications from cancer, until he passed away in 2018. Jeopardy! has left such a huge mark on my life, and because there are so many aspects of Jeopardy! to analyze, this made for good data to wrangle.   

## Data Sources

  For my project, I will be scraping data from the J-Archive (https://j-archive.com/), which is a fan run archive of most of the games from the Alex Trebek era of Jeopardy!. The site is broken down to different pages for each individual game. To find the different games each contestant played in, I will scrape from their different player profile pages, 16 pages in total. An example page for Jason Zuffranieri is http://www.j-archive.com/showplayer.php?player_id=12824. On this page, I will be pulling the various games each contestant played in and scraping data from that specific game's web page. An example is based on Jason's player page, I know he played in Game #8046, which is also the 36th season permiere. So I will be scraping data from that page, http://www.j-archive.com/showgame.php?game_id=6410. For that specific game, I will then be scraping data from the score breakdown page, which for the example game #8046 is http://www.j-archive.com/showscores.php?game_id=6410. I will be repeating this process for each game a contestant has played in. Using Jason as an example, he has played in 20 regular season games of Jeopardy!, so I will be scraping 20 game level sites and 20 score breakdown sites.
  
<Should I potentially add screenshots here?>

## Data Scraping

My main data frame was constructed starting with an empty data frame and a data frame consisting of the full names of contestants, player ids to link them to different pages on the J-Archive!, and the Team they played on during the Jeopardy All-Stars Tournament that aired in 2019. A contestant may appear multiple times if more than one player page was required to pull all of the games they played in.

```{r contestants, echo = FALSE}
contestants <- data.frame(
  Contestants = c("Brad Rutter", "Brad Rutter", "Brad Rutter", "Ken Jennings", "Ken Jennings", "James Holzhauer", "David Madden", "Larissa Kelly", "Larissa Kelly", "Matt Jackson", "Jason Zuffranieri", "Roger Craig", "Roger Craig", "Colby Burnett", "Colby Burnett", "Julia Collins"), playerIds = c(278, 622, 12536, 661, 12547, 12983, 1963, 4956, 12539, 10266, 12824, 6976, 12550, 8057, 12537, 9517), AllStarsTeam = c("Team Brad", "Team Brad", "Team Brad", "Team Ken", "Team Ken", "No Team", "Team Brad", "Team Brad", "Team Brad", "Team Ken", "No Team", "Team Austin", "Team Austin", "Team Colby", "Team Colby", "Team Julia"), stringsAsFactors = FALSE
)
contestant_names <- c("Brad Rutter", "Ken Jennings", "James Holzhauer", "David Madden", "Larissa Kelly", "Matt Jackson", "Jason Zuffranieri", "Roger Craig", "Colby Burnett", "Julia Collins")
contestants
```

```{r dataScraping, echo = FALSE, warning = FALSE}
game_level_df <- data.frame(Contestant = character(),
                            GameIdForUrl = integer(),
                            GameId = integer(),
                            Date = character(),
                            FinalScore = integer(),
                            Outcome = character(),
                            GameFormat = character(), 
                            TournamentName = character(),
                            CoryatScore = integer(),
                            stringsAsFactors = FALSE
)

for (row in 1:nrow(contestants)) {
  contestant <- contestants[row, 1]
  player_id <- contestants[row, 2]
  allStarTeam <- contestants[row, 3]
  gameIdsForUrl <- getGameIdsForUrl(player_id)
  for (row in 1:nrow(gameIdsForUrl)) {
    gameIdForUrl <- gameIdsForUrl[row, 1]
    rowForGameLevelTable <- getRowForGameLevelTable(contestant, gameIdForUrl, allStarTeam)
    if(rowForGameLevelTable != "Don't include"){
      game_level_df <- rbind(game_level_df, rowForGameLevelTable)
    }
  }
}
game_level_df <- game_level_df %>%
  distinct()
game_level_df$Outcome <- as.character(game_level_df$Outcome)
```

Once I created this table, I iterated through the rows of the contestant table. Using the player id, I scraped the player pages on J-Archive to find the different game ids pertaining to their specific games. To do this, I extracted all of the "a" nodes and pulled the game id from the href tags using regular expressions, by searching for digits. This was difficult because there are two types of "game ids". The first the game's position in the sequence of Jeopardy games, which is what is included in my final table and used for the purpose of arranging the table by date game is played. The other game id, which is what I am interested in for this purpose, is the id used in the url, which is probably the sequence of when the game was added. The latter wasn't easily grabbed by CSS selector, so I was forced to check the class in the tag.

The once I had the list of game ids, I iterated through that list to scrape the individual game level and score sites, similar to those mentioned in the "Data Sources" paragraph. From these sites, I was able to extract notes about the game (i.e. was it a tournament game or regular season game), the game id (this time, talking about the episode number), the date that game aired, the final score, the outcome (did the player win or lose, or in the event of a tournament, did they automatically advance, or rely on a wildcard spot). I then added a row to my data frame consisting of this information, along with the contestant's name.

Most of this data was compiled scraping various nodes of the two sites. There were some pain points. First, there were some games that were split into multiple episodes. In particular, this was done during the IBM Watson exhibition matches in 2011, and the first round of the Jeopardy All Star Games competition in 2019. Because I am only interested in final scores, I had to exclude these games by check if the game comments mentioned that the episode was the Jeopardy Round only. Second, the Final Jeopardy table on the game site was incosistent between episodes. This was most often the case during finals of Tournaments, where the winner is determined by a two day total. So I needed to check how many columns were in table and add an Outcome column if it wasn't there, and noting that the game is an Accumulated game. The last issue I had was with the All Star Games - the Final Jeopardy table name was the name of the team, so I had to add an input to my function with the All Star team and assign the game to a contestant if the name in the table was either their name, or the name of their All Star Team. Below is what the table looks like for the contestant Roger Craig, who competed in Regular Season play, the Tournament of Champions, the Battle of the Decades, and the All Star games:

```{r dataScrapingOutput, echo = FALSE}
game_level_df %>%
  filter(Contestant == "Roger Craig") %>%
  arrange(desc(GameId))
```

## All-Time Winnings
<Now talk about how I separated regular season winnings from tournament winnings, and output bar graph>

```{r AllTimeWinnings, echo = FALSE}
tournament_winnings_df <- data.frame(
  Contestant = character(),
  TournamentName = character(),
  Outcome = character(),
  Winnings = integer(),
  stringsAsFactors = FALSE
)
game_level_df_tournament <- game_level_df %>%
  filter(TournamentName != "Regular Season") %>%
  select(Contestant, TournamentName) %>%
  distinct()
for (row in 1:nrow(game_level_df_tournament)) {
  contestant <- game_level_df_tournament[row, 1]
  tournamentName <- game_level_df_tournament[row, 2]
  rowForTournamentWinningTable <- getRowForTournamentWinningsTable(contestant, tournamentName)
  tournament_winnings_df <- rbind(tournament_winnings_df, rowForTournamentWinningTable)
}
game_level_df_regular_season <- game_level_df %>%
  filter(TournamentName == "Regular Season") %>%
  select(Contestant, GameId, TournamentName, FinalScore, Outcome)
for (contestant in contestant_names) {
    if(contestant != "Brad Rutter") {
    game_level_df_regular_season_filtered <- game_level_df_regular_season %>%
      filter(Contestant == contestant) %>%
      filter(GameId == max(GameId))
    gameId <- game_level_df_regular_season_filtered$GameId
    winnings <- str_extract(game_level_df_regular_season_filtered$Outcome,"(?<=:\\s).*") %>%
      str_replace_all("\\$|,", "") %>%
      as.numeric()
    game_level_df_regular_season[game_level_df_regular_season$GameId == gameId, "FinalScore"] <- winnings
  }
}
winnings_df <- game_level_df_regular_season %>%
  select(Contestant, TournamentName, Outcome, FinalScore)
colnames(winnings_df)[4] <- "Winnings"
winnings_df <- winnings_df %>%
  rbind(tournament_winnings_df) %>%
  mutate(Format = ifelse(TournamentName == "Regular Season", "Regular Season", "Tournament"))
```
<Talk about now plotting graphs>
```{r winningsPlots, echo = FALSE}
winnings_df %>%
  select(Contestant, Format, Winnings) %>%
  group_by(Contestant, Format) %>%
  summarize(CummulativeEarnings = sum(Winnings)) %>%
  mutate(CummulativeEarnings = ifelse(is.na(CummulativeEarnings), 0, CummulativeEarnings)) %>%
  ggplot() +
  geom_bar(mapping = aes(x = Contestant, y = CummulativeEarnings, fill = Format), stat ="identity") +
  ggtitle("Earnings of Top Ten All-Time Winning Jeopardy Contestants") +
  theme(axis.text.x = element_text(angle = 90))
```

```{r winningsPlot2, echo=FALSE}
winnings_df %>%
  select(Contestant, TournamentName, Winnings) %>%
  group_by(Contestant, TournamentName) %>%
  summarize(CummulativeEarnings = sum(Winnings)) %>%
  mutate(CummulativeEarnings = ifelse(is.na(CummulativeEarnings), 0, CummulativeEarnings)) %>%
  ggplot() +
  geom_bar(mapping = aes(x = Contestant, y = CummulativeEarnings, fill = TournamentName), stat ="identity") +
  ggtitle("Earnings of Top Ten All-Time Winning Jeopardy Contestants by Tournament") +
  theme(axis.text.x = element_text(angle = 90))
```

## Scores Plotting

<Talk about how we will plot scores (not winnings) over course of regular season>

```{r scorePlotting, echo=FALSE}
game_scores_df_regular_season <- game_level_df %>%
  filter(TournamentName == "Regular Season") %>%
  select(Contestant, GameId, FinalScore) %>%
  group_by(Contestant) %>%
  mutate(GamePlayed = min_rank(GameId))
ggplot(data = game_scores_df_regular_season,mapping = aes(x = GamePlayed, y = FinalScore, color = Contestant)) +
  geom_point() +
  geom_line() +
  ggtitle("Final Scores for All-Time Winning Jeopardy Contestants - Regular Season") +
  xlab("Game") +
  ylab("Final Score")
ggplot(data = game_scores_df_regular_season,mapping = aes(x = GamePlayed, y = FinalScore)) +
  geom_point() +
  geom_line() +
  ggtitle("Final Scores for All-Time Winning Jeopardy Contestants - Regular Season") +
  xlab("Game") +
  ylab("Final Score") +
  facet_wrap(~ Contestant, nrow = 5)
```

<Discuss skews due to Brad's winnings being pre-doubled and James' due to aggresive wagering. Move on to Coryat Score>

## Coryat Score

<Discuss what Coryat Score is, origin, and other manipulation done to data (i.e. Brad's doubling for regular season games), will plot max and average scores, also will exclude All Star games since that was three person game>

```{r coryatScores, echo=FALSE, warning = FALSE}
coryat_scores_df <- game_level_df %>%
  filter(TournamentName != "All-Star Games") %>%
  rowwise() %>%
  mutate(FinalScoreAdjusted = ifelse(GameId < 3966 && TournamentName != "Greatest of All Time", FinalScore*2, FinalScore),
         CoryatScoreAdjusted = ifelse(GameId < 3966 && TournamentName != "Greatest of All Time", CoryatScore*2, CoryatScore)) %>%
  select(Contestant, FinalScoreAdjusted, CoryatScoreAdjusted) %>%
  group_by(Contestant) %>%
  summarize(MaxFinalScore = max(FinalScoreAdjusted),
            AverageFinalScore = mean(FinalScoreAdjusted),
            MaxCoryatScore = max(CoryatScoreAdjusted),
            AverageCoryatScore = mean(CoryatScoreAdjusted))
coryat_scores_df <- coryat_scores_df %>%
  gather("MaxFinalScore", "AverageFinalScore", "MaxCoryatScore", "AverageCoryatScore", key = "Attribute", value = "Score")
ggplot(data = coryat_scores_df, mapping = aes(x = Contestant, y = Score, color = Attribute, size = Attribute)) +
  geom_point() +
  ggtitle("Coryat Scores versus Final Scores") +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_color_discrete(name = "Score Type",
                       labels = c("Average Coryat Score", "Average Final Score", "Max Coryat Score", "Max Final Score")) +
  scale_y_continuous(breaks = seq(0,140000,20000)) +
  scale_size_discrete(name = "Score Type",
                       labels = c("Average Coryat Score", "Average Final Score", "Max Coryat Score", "Max Final Score"))
  
```

